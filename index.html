
<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>気温・風・降水分布の表示</title>
 	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
	<link rel="icon" href="./favicon.svg" type="image/svg+xml">
	<link rel="apple-touch-icon" href="./favicon180.png" sizes="180x180">
	<link rel="icon alternate" type="image/png" href="./favicon192.png" sizes="192x192">
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<!-- 矢羽根の回転に使用 Copyright (c) 2015 Benjamin Becquet https://github.com/bbecquet/Leaflet.RotatedMarker/blob/master/LICENSE -->
	<script src="https://bbecquet.github.io/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
	
	<!-- 地図表示のコード -->
	<script src="./AMeDASmap.js"></script>
	<style>
		html, body {height: 100%; width: 100%; margin:0px; padding:0px; border:0px; font-family:"Helvetica Neue", Arial, Helvetica, sans-serif;}
		h1 {margin:0px; padding:0px; border:0px; font-size:18px; font-weight:600; line-height:18px; color:#04C; text-align:left; float:left; }
		#leafletmap{height: 100%; width: 100%; margin:0px; padding:0px; border:0px; position:relative;}
		#menu{overflow:hidden; float:left; padding:0px; margin:0px; border:0px; background-color: #DEF; position:absolute; top:0px; left:0px; z-index:9999;}
		#menu_topunder {overflow:hidden; width: 100%;}
		.btnOther,#btnExpandMenu, #btnCurPos{color: #FFF; background-color: #08F; border-radius:2px; text-decoration:none; padding:1px;}
		#menu_sub{display:none; overflow:hidden}
		.menu_subCat{width:100%; margin:0; padding:5px; border-top:solid 1px #08A; background-color:#DEF;}
		#lsDateTime{font-size:16px; background-color: #DEF;}
		#btnLegend{color: #FFF; background-color: #08F; border-radius:2px; text-decoration:none; padding:1px;}
		#btnRadar{color: #FFF; background-color: #08F; border-radius:2px; text-decoration:none; padding:1px;}
		#btnOpacity{font-size:14px; color: #FFF; background-color: #08F; border-radius:2px; text-decoration:none; padding:1px;}
		.txtTemp{font-size:16pt; transform:scale(0.8); text-align:right; width:30px; background:#DEF; }
		
		.StrTemp00{color:#002080; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #FFF, -1px -1px 0px #FFF, -1px 1px 0px #FFF, 1px -1px 0px #FFF, 1px 0px 0px #FFF, -1px  0px 0px #FFF, 0px 1px 0px #FFF, 0px -1px 0px #FFF;}
		.StrTemp01{color:#0039E4; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #FFF, -1px -1px 0px #FFF, -1px 1px 0px #FFF, 1px -1px 0px #FFF, 1px 0px 0px #FFF, -1px  0px 0px #FFF, 0px 1px 0px #FFF, 0px -1px 0px #FFF;}
		.StrTemp02{color:#006CFF; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp03{color:#5DC1FF; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp04{color:#DCF5F8; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp05{color:#FFFFC3; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp06{color:#FDFA4B; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp07{color:#FDC700; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp08{color:#FF6100; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #000, -1px -1px 0px #000, -1px 1px 0px #000, 1px -1px 0px #000, 1px 0px 0px #000, -1px  0px 0px #000, 0px 1px 0px #000, 0px -1px 0px #000;}
		.StrTemp09{color:#E41440; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #FFF, -1px -1px 0px #FFF, -1px 1px 0px #FFF, 1px -1px 0px #FFF, 1px 0px 0px #FFF, -1px  0px 0px #FFF, 0px 1px 0px #FFF, 0px -1px 0px #FFF;}
		.StrTemp10{color:#C80080; font-size:12px; line-height:12px; font-weight:800; text-align:center; text-shadow: 1px 1px 0px #FFF, -1px -1px 0px #FFF, -1px 1px 0px #FFF, 1px -1px 0px #FFF, 1px 0px 0px #FFF, -1px  0px 0px #FFF, 0px 1px 0px #FFF, 0px -1px 0px #FFF;}

		.legend {line-height: 20px; color: #555; background-color: #FFF; padding: 2px}
		.legend i {width: 18px; height: 18px; float: left; margin-right: 8px;  opacity: 1;}

		.bg_onetime_popup {position:fixed; top:0px ;left:0px; z-index:9999; width:100%; height:100%; background-color:rgba(0, 0, 0, 0.5); opacity:0; visibility:hidden; transition:0.5s; }
		.bg_onetime_popup.js_active {opacity:1; visibility:visible;}
		.onetime_popup {position:absolute; top:50%; left:50%; transform:translateX(-50%) translateY(-50%); width:70%; min-width: 300px;background-color: #fff;cursor: pointer;}
		.onetime_popup_title { position:relative; padding:5px 5px; margin:0px; background-color: #3388dd; color: #fff; font-size: 16px; text-align: center; line-height: 20px;}
		.onetime_popup_title::before,
		.onetime_popup_title::after {position:absolute; top:50%; right: 20px; transform: translateY(-50%); width:20px; height: 2px; background-color: #fff; content: "";}
		.onetime_popup_title::before { transform: rotate(45deg); }
		.onetime_popup_title::after { transform: rotate(-45deg); }
		.onetime_popup_content { padding: 30px 30px; text-align: left; font-size:12px }
		
	</style>
</head>
<body>
	<!-- 念のための表示はじまり -->
	<!-- 参考: https://migi.me/javascript/popup-modal-window-only-once/ -->
	<script type="text/javascript">
	    window.addEventListener('load', function() {
	        if( !localStorage.getItem('disp_popup') ) {
	            localStorage.setItem('disp_popup', 'on');
	            var popup = document.getElementsByClassName('bg_onetime_popup');
	            popup[0].classList.add('js_active');
	            popup[0].onclick = function() {
	                popup[0].classList.remove('js_active');
	            }
	        }
	    }, false);
	</script>
	<div class="bg_onetime_popup">
	    <div class="onetime_popup">
	        <p class="onetime_popup_title">このページについて(免責事項)</p>
	        <div class="onetime_popup_content">
	        	このウインドウを閉じた時点、下記の全てに同意したものとみなします。
	        	<ul style="list-style-type:disc">
	        		<li>このページの作者は、このサイトから入手された情報により発生した、あらゆる損害に関して一切の責任を負いません。</li>
	        		<li>このページは、作者が個人的に使用する目的で作成したものであり、常に正常に動作することを第三者に対して保証するものではありません。
	        			処理等にバグ等の不具合があったとしても、作者は修正の責任を負わないものとします。</li>
	        		<li>このページは気象庁サイトから取得してきたJSONを元に図化しているものです。
	        			JSONの仕様等は公表されておらず、推測に基づいて解読しています。そのため、JSONの解釈に誤りがあったり、予告なしに変更される可能性があります。
	        			解釈の誤りや仕様変更等があった場合でも、作者は修正の義務を負わないものとします。</li>
	        	</ul>
	        </div>
	    </div>
	</div>
	<!-- 念のための表示おわり -->
	
	<!-- メニュー -->
	<div id="menu">
		<select id="lsDateTime" onchange="GetSelectedDateForA()">
		</select>
		<a href="javascript:GetTimes()" class="btnOther">更新</a>
		<a href="javascript:OffsetTime(1)" class="btnOther">-10分</a>
		<a href="javascript:OffsetTime(-1)" class="btnOther">+10分</a>
		<div id="menu_topunder">
			<a href="javascript:ExpandMenu()" id="btnExpandMenu">その他の設定</a>
			<a href="javascript:MoveToCurPos()" id="btnCurPos">現在地</a>
		</div>
		<div id="menu_sub">
			<div class="menu_subCat">
				レーダー画像 <a href="javascript:SwitchRadar()" id="btnRadar">表示</a><br>
				透過度 <input type="range" min="0" max="100" value=0 step="1" id="sldRadar" style="width:100px;">
			</div>
			<div class="menu_subCat">
				気温凡例 <a href="javascript:SwitchLegendT()" id="btnLegend">表示</a><br>
				<form name="legend_temp">
					<label><input name="tscale" type="radio" value="jma" checked>気象庁</label><br>
					<label><input name="tscale" type="radio" value="tokyo">自動設定(月別)</label><br>
					<label><input name="tscale" type="radio" value="original">独自2<span style="font-size:12px">(入力後反映ボタンを押下)</span></label>
					<a href="javascript:SetTempRangeOriginal()" class="btnOther">反映</a><br>
					T<span style="vertical-align:sub;">0</span>:<input type="text" value="-10" class="txtTemp">
					<span style="vertical-align:sub;">Δ</span>T:<input type="text" value="5" class="txtTemp">
				</form>
			</div>
			<div class="menu_subCat">
				背景図選択
				<label><input name="lyr" type="radio" value="blk" checked>白地図</label>
				<label><input name="lyr" type="radio" value="pal">淡色地図</label>
			</div>
		</div>
	</div>
	<div id="leafletmap">
		<script language="javascript" type="text/javascript">
		//▼グローバル変数
		const MaxWind = 35; //上限となる風速(これ以上の矢羽根未整備)
		let dLon, dLat, dZoom;
		let lyTempStr, lyTempCrl, lyWindBarbL, lyWindBarbS; //気温文字、気温○、矢羽根(大)、矢羽(小)
		let lyPal, lyBlk; //ベースレイヤ
		let lyRadar; //レーダー
		let lcMain; //レイヤコントロール
		let htObsInfo = null; //観測点の情報(Key:観測点コード)
		let gjPoints = null;
		let ctLegT = null;
		let arRadarTs = null; //レーダー画像の時刻(JST)
		let elSlider = document.getElementById('sldRadar'); //透過度
		elSlider.addEventListener('change', ChangeRadarOpacity);
		
		//カラーコード・最低カテゴリ上限値(月別)・カテゴリのStep
		const sColors = ["#002080", "#0039E4", "#006CFF", "#5DC1FF", "#DCF5F8", "#FFFFC3", "#FDFA4B", "#FDC700", "#FF6100", "#E41440", "#C80080"];
		let dMinTs = [-2, -2, 0, 6, 10, 14, 18, 18, 14, 10, 4, 0]; //独自の配色用(月別)
		let dMinT = -10; //デフォルト(気象庁配色)
		let dTStep = 5;  //デフォルト(気象庁配色)
		
		//地図を生成（初期表示の中心座標，ズームレベル，レイヤなどをオプションで設定）
		GetParams();
		let map = L.map('leafletmap', {center:[dLat,dLon], zoomControl:false, zoom:dZoom, minZoom:5, maxZoom:16});
		
		//ペイン
		let pnCrl = map.createPane("PaneCircle");
		let pnRdr = map.createPane("PaneRadar");
		pnRdr.style.mixBlendMode = "multiply"; //乗算合成
		pnCrl.style.zIndex = 640;
		
		//▼ここから表示処理呼び出し
		GetTimes();
		
		//タイルレイヤ追加
		//切り替え可能とするタイルレイヤを生成（タイルURL，ズーム範囲，著作権表示などをオプションで設定）
		lyPal = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
			minZoom:5, maxZoom:18, 
			attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
			});
		lyBlk = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
			minZoom:5, maxZoom:16, maxNativeZoom:14, opacity:0.7,
			attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
			});
		lyBlk.addTo(map);
		
		//スケールコントロールを追加（オプションはフィート単位を非表示）
		L.control.scale({imperial: false}).addTo(map);
		
		//凡例表示
		SwitchLegendT();
		
		//▼mapイベント:ズームレベル変更時の表示制御
		//zoom < 9  では lyTempCrl, lyWindBarbSを表示
		//9 <= zoom では lyTempCrl, lyTempStr, lyWindBarbLを表示
		map.on('zoomend', LayerSwitchByZScale);

		//▼mapイベント:移動終了→中心位置取得→URL変更
		map.on('moveend', function(){
			dLon = map.getCenter().lng.toFixed(6);
			dLat = map.getCenter().lat.toFixed(6);
			ReplaceURL();
		});
		
	</script>
	</div>
</body>
</html>